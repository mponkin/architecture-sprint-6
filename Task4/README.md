# Задание 4. Проектирование продажи ОСАГО

Дано:

Компания планирует вскоре запустить новый продукт: оформление ОСАГО онлайн. Пользовательский путь выглядит так: клиенту предлагается заполнить заявку с информацией о своём автомобиле, после этого сервис запрашивает у всех доступных страховых компаний предложения с условиями страхования под заявку клиента. 

Бизнесу важно, чтобы на экране пользователя предложения от каждой страховой компании отображались сразу, как только от неё пришёл ответ. 

Максимальное время ожидания решения от страховой компании — 60 секунд. 
Все страховые компании предоставляют однотипные REST API с двумя эндпоинтами:
- создать заявку на ОСАГО,
- получить предложение по заявке.

Бизнес предполагает, что в пик нагрузки количество одновременных пользователей, создающих заявку на ОСАГО, может достигать 2,5 тысячи человек.

Вы обсудили задачу с командой разработки и приняли такие решения:

- Сохранить подход, который использовался для получения данных о продуктах и тарифах из страховых компаний.
- Выделить отдельный сервис для взаимодействия со страховыми компаниями — **osago-aggregator**.

Функциональная обязанность этого сервиса — отправка заявок в страховые компании и дальнейший опрос решений по ним для передачи результатов в **core-app**. 

Остальная функциональность, связанная с оформлением ОСАГО, остаётся на стороне бэкенда в **core-app**.

## Результирующая схема
[InsureTech_C4_сontainer-diagram.drawio](./InsureTech_C4_сontainer-diagram.drawio.xml)

## Реализация флоу

**1. Веб-приложение InsureTech** 
- Пользователь оформляет заявку 

**2. core-app**
- Сохраняет данные с формы от пользвотеля в базу данных
- С помощью Transaction Outbox публикует событие о заявке пользователя 

**3. osago-aggregator**
- Читает сообщение опубликованное ранее **core-app** об оформленной заявке
- Сохраняет в базу данных данные об оформленной заявке
- Асинхронно с помощью фонового процесса обращается в сторонее API страховых компаний и создает ОСАГО заявки
- Сохраняет результат о созданной ранее заявки к себе в базу данных
- Асинхронного с помощью фонового процесса опрашивает стороннее API о предложении страховой компании по созданной ранее заявке
- Сохраняет результат о предложении страховой компании
- С помощью Transactional Outbox публикует событие о предложении страховой компании по заявке пользователя

**4. core-app** 
- Читает событие о предложении страховой компании
- С помощью Web Sockets отправляет информацию клиенту

**5. Веб-приложение InsureTech**
- Слушает сокет **core-app**
- Отображает информацию клиету при получении предложения о страховой компании 

## Паттерны отказоустойчивости

- **Веб-приложение InsureTech** -> **core-app**:
  - при оформлении заявок необходимо установить Rate Limitng на уровне API Gateway для ограничения кол-ва пользователей ~ 2,5к

- **core-app** <-> **osago-aggregator**:
  - При отправки событий необходимо использовать Transaction Outbox для гарантированной доставки событий

- **osago-aggregator** -> внешнее API страховых компаний при отправки запросов:
  - Circuit Breaker
  - Retry
  - Timeout 60 секунд
